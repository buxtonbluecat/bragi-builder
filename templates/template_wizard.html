{% extends "base.html" %}

{% block title %}Template Wizard - Bragi Builder{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-magic"></i> Template Wizard
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#newWizardModal">
                <i class="fas fa-plus"></i> New Template
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="location.reload()">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
    </div>
</div>

<!-- Wizard Sessions -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Template Wizard Sessions</h5>
            </div>
            <div class="card-body">
                <div id="wizardSessionsList">
                    <!-- Sessions will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Wizard Steps (hidden by default) -->
<div id="wizardSteps" class="row" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0" id="wizardTitle">Template Wizard</h5>
                    <div class="btn-group">
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="goToStep(1)">
                            <i class="fas fa-arrow-left"></i> Previous
                        </button>
                        <button type="button" class="btn btn-sm btn-primary" onclick="nextStep()">
                            Next <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
                <!-- Progress Bar -->
                <div class="progress mt-3" style="height: 8px;">
                    <div class="progress-bar" role="progressbar" id="progressBar" style="width: 0%"></div>
                </div>
            </div>
            <div class="card-body">
                <div id="wizardContent">
                    <!-- Wizard content will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New Wizard Modal -->
<div class="modal fade" id="newWizardModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Template</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="newWizardForm">
                    <div class="mb-3">
                        <label for="templateName" class="form-label">Template Name</label>
                        <input type="text" class="form-control" id="templateName" name="template_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="templateDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="templateDescription" name="description" rows="3" 
                                  placeholder="Describe what this template will create..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createWizardSession()">Create Template</button>
            </div>
        </div>
    </div>
</div>

<!-- Resource Selection Modal -->
<div class="modal fade" id="resourceSelectionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Resource</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row" id="resourceGrid">
                    <!-- Resource cards will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Resource Configuration Modal -->
<div class="modal fade" id="resourceConfigModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Configure Resource</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="resourceConfigForm">
                    <input type="hidden" id="selectedResourceType" name="resource_type">
                    <input type="hidden" id="currentSessionId" name="session_id">
                    <div id="resourceConfigFields">
                        <!-- Configuration fields will be loaded here -->
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addResourceToSession()">Add Resource</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentWizardSession = null;
let currentStep = 1;
let totalSteps = 5;

// Load wizard sessions on page load
document.addEventListener('DOMContentLoaded', function() {
    loadWizardSessions();
});

function loadWizardSessions() {
    fetch('/template-wizard/sessions')
    .then(response => response.json())
    .then(data => {
        displayWizardSessions(data.sessions || []);
    })
    .catch(error => {
        console.error('Error loading wizard sessions:', error);
    });
}

function displayWizardSessions(sessions) {
    const container = document.getElementById('wizardSessionsList');
    
    if (sessions.length === 0) {
        container.innerHTML = '<p class="text-muted">No wizard sessions found. Create one to get started.</p>';
        return;
    }
    
    container.innerHTML = sessions.map(session => `
        <div class="card mb-3">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <h6 class="card-title">${session.session_name}</h6>
                        <p class="card-text">${session.description || 'No description'}</p>
                        <div class="mb-2">
                            <span class="badge bg-primary">Step ${session.step}/${session.total_steps}</span>
                            <span class="badge bg-info">${session.selected_resources} resources</span>
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        <button class="btn btn-sm btn-outline-primary" onclick="openWizardSession('${session.session_id}')">
                            <i class="fas fa-edit"></i> Continue
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteWizardSession('${session.session_id}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

function createWizardSession() {
    const form = document.getElementById('newWizardForm');
    const formData = new FormData(form);
    
    const data = {
        template_name: formData.get('template_name'),
        description: formData.get('description')
    };
    
    fetch('/template-wizard/sessions', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Wizard session created successfully!');
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        alert('Error: ' + error);
    });
}

function openWizardSession(sessionId) {
    currentWizardSession = sessionId;
    
    fetch(`/template-wizard/sessions/${sessionId}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentStep = data.session.step;
            totalSteps = data.session.total_steps;
            displayWizardStep(data.session);
            document.getElementById('wizardSteps').style.display = 'block';
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        alert('Error: ' + error);
    });
}

function displayWizardStep(session) {
    document.getElementById('wizardTitle').textContent = `Template Wizard - ${session.session_name}`;
    updateProgressBar();
    
    const content = document.getElementById('wizardContent');
    
    switch (currentStep) {
        case 1:
            displayStep1(session);
            break;
        case 2:
            displayStep2(session);
            break;
        case 3:
            displayStep3(session);
            break;
        case 4:
            displayStep4(session);
            break;
        case 5:
            displayStep5(session);
            break;
    }
}

function displayStep1(session) {
    const content = document.getElementById('wizardContent');
    content.innerHTML = `
        <h4>Step 1: Template Information</h4>
        <p class="text-muted">Provide basic information about your template.</p>
        
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label class="form-label">Template Name</label>
                    <input type="text" class="form-control" id="wizardTemplateName" value="${session.session_name}" readonly>
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label class="form-label">Description</label>
                    <input type="text" class="form-control" id="wizardDescription" value="${session.description || ''}" readonly>
                </div>
            </div>
        </div>
        
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            This template will be created in your Azure resource group and can be used for deployments.
        </div>
    `;
}

function displayStep2(session) {
    const content = document.getElementById('wizardContent');
    content.innerHTML = `
        <h4>Step 2: Select Resources</h4>
        <p class="text-muted">Choose the Azure resources you want to include in your template.</p>
        
        <div class="mb-3">
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#resourceSelectionModal">
                <i class="fas fa-plus"></i> Add Resource
            </button>
        </div>
        
        <div id="selectedResourcesList">
            ${session.selected_resources.map(resource => `
                <div class="card mb-2">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0">${resource.display_name}</h6>
                                <small class="text-muted">${resource.resource_type}</small>
                            </div>
                            <button class="btn btn-sm btn-outline-danger" onclick="removeResource('${resource.resource_name}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('')}
        </div>
        
        ${session.selected_resources.length === 0 ? '<p class="text-muted">No resources selected yet. Click "Add Resource" to get started.</p>' : ''}
    `;
}

function displayStep3(session) {
    const content = document.getElementById('wizardContent');
    content.innerHTML = `
        <h4>Step 3: Configure Parameters</h4>
        <p class="text-muted">Define parameters that can be customized when deploying the template.</p>
        
        <div class="mb-3">
            <button type="button" class="btn btn-primary" onclick="addParameter()">
                <i class="fas fa-plus"></i> Add Parameter
            </button>
        </div>
        
        <div id="parametersList">
            ${Object.keys(session.parameters).map(paramName => `
                <div class="card mb-2">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <strong>${paramName}</strong>
                            </div>
                            <div class="col-md-3">
                                <span class="badge bg-secondary">${session.parameters[paramName].type}</span>
                            </div>
                            <div class="col-md-4">
                                <small>${session.parameters[paramName].description}</small>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-sm btn-outline-danger" onclick="removeParameter('${paramName}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('')}
        </div>
        
        ${Object.keys(session.parameters).length === 0 ? '<p class="text-muted">No parameters defined yet. Click "Add Parameter" to get started.</p>' : ''}
    `;
}

function displayStep4(session) {
    const content = document.getElementById('wizardContent');
    content.innerHTML = `
        <h4>Step 4: Define Outputs</h4>
        <p class="text-muted">Specify values that should be returned after deployment.</p>
        
        <div class="mb-3">
            <button type="button" class="btn btn-primary" onclick="addOutput()">
                <i class="fas fa-plus"></i> Add Output
            </button>
        </div>
        
        <div id="outputsList">
            ${Object.keys(session.outputs).map(outputName => `
                <div class="card mb-2">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <strong>${outputName}</strong>
                            </div>
                            <div class="col-md-3">
                                <span class="badge bg-secondary">${session.outputs[outputName].type}</span>
                            </div>
                            <div class="col-md-4">
                                <code>${session.outputs[outputName].value}</code>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-sm btn-outline-danger" onclick="removeOutput('${outputName}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('')}
        </div>
        
        ${Object.keys(session.outputs).length === 0 ? '<p class="text-muted">No outputs defined yet. Click "Add Output" to get started.</p>' : ''}
    `;
}

function displayStep5(session) {
    const content = document.getElementById('wizardContent');
    content.innerHTML = `
        <h4>Step 5: Review & Generate</h4>
        <p class="text-muted">Review your template configuration and generate the final ARM template.</p>
        
        <div class="row">
            <div class="col-md-6">
                <h5>Template Summary</h5>
                <ul class="list-group">
                    <li class="list-group-item d-flex justify-content-between">
                        <span>Resources</span>
                        <span class="badge bg-primary">${session.selected_resources.length}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <span>Parameters</span>
                        <span class="badge bg-info">${Object.keys(session.parameters).length}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <span>Outputs</span>
                        <span class="badge bg-success">${Object.keys(session.outputs).length}</span>
                    </li>
                </ul>
            </div>
            <div class="col-md-6">
                <h5>Actions</h5>
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" onclick="generateTemplate()">
                        <i class="fas fa-magic"></i> Generate Template
                    </button>
                    <button class="btn btn-outline-secondary" onclick="previewTemplate()">
                        <i class="fas fa-eye"></i> Preview Template
                    </button>
                    <button class="btn btn-outline-info" onclick="validateTemplate()">
                        <i class="fas fa-check"></i> Validate Template
                    </button>
                </div>
            </div>
        </div>
    `;
}

function updateProgressBar() {
    const progress = (currentStep / totalSteps) * 100;
    document.getElementById('progressBar').style.width = progress + '%';
}

function nextStep() {
    if (currentStep < totalSteps) {
        currentStep++;
        updateWizardStep();
    }
}

function goToStep(step) {
    if (step >= 1 && step <= totalSteps) {
        currentStep = step;
        updateWizardStep();
    }
}

function updateWizardStep() {
    fetch(`/template-wizard/sessions/${currentWizardSession}/step`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ step: currentStep })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayWizardStep(data.session);
        }
    })
    .catch(error => {
        console.error('Error updating step:', error);
    });
}

function loadResourceGrid() {
    fetch('/template-wizard/resources')
    .then(response => response.json())
    .then(data => {
        const grid = document.getElementById('resourceGrid');
        grid.innerHTML = data.resources.map(resource => `
            <div class="col-md-4 mb-3">
                <div class="card h-100">
                    <div class="card-body">
                        <h6 class="card-title">${resource.display_name}</h6>
                        <p class="card-text">${resource.description}</p>
                        <small class="text-muted">API Version: ${resource.api_version}</small>
                    </div>
                    <div class="card-footer">
                        <button class="btn btn-primary btn-sm w-100" onclick="selectResource('${resource.type}')">
                            <i class="fas fa-plus"></i> Add
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
    })
    .catch(error => {
        console.error('Error loading resources:', error);
    });
}

function selectResource(resourceType) {
    document.getElementById('selectedResourceType').value = resourceType;
    document.getElementById('currentSessionId').value = currentWizardSession;
    
    // Load configuration form
    const encodedResourceType = encodeURIComponent(resourceType);
    console.log('Loading config for resource type:', resourceType, 'encoded:', encodedResourceType);
    
    fetch(`/template-wizard/resources/${encodedResourceType}/config`)
    .then(response => {
        console.log('Response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Config data received:', data);
        const fieldsContainer = document.getElementById('resourceConfigFields');
        
        if (!data.fields || data.fields.length === 0) {
            fieldsContainer.innerHTML = '<p class="text-muted">No configuration fields available for this resource type.</p>';
        } else {
            // Add resource name field first
            fieldsContainer.innerHTML = `
                <div class="mb-3">
                    <label for="name" class="form-label">
                        Resource Name <span class="text-danger">*</span>
                    </label>
                    <input type="text" class="form-control" id="name" name="name" 
                           placeholder="Enter resource name" required>
                    <div class="form-text">This will be the name of the resource in Azure</div>
                </div>
            `;
            
            // Add other fields
            fieldsContainer.innerHTML += data.fields.map(field => `
                <div class="mb-3">
                    <label for="${field.name}" class="form-label">
                        ${field.label}
                        ${field.required ? '<span class="text-danger">*</span>' : ''}
                    </label>
                    ${field.type === 'select' ? `
                        <select class="form-select" id="${field.name}" name="${field.name}" ${field.required ? 'required' : ''}>
                            <option value="">Select ${field.label}</option>
                            ${field.options.map(option => `<option value="${option}">${option}</option>`).join('')}
                        </select>
                    ` : field.type === 'password' ? `
                        <input type="password" class="form-control" id="${field.name}" name="${field.name}" ${field.required ? 'required' : ''}>
                    ` : `
                        <input type="${field.type}" class="form-control" id="${field.name}" name="${field.name}" 
                               placeholder="${field.placeholder}" ${field.required ? 'required' : ''}>
                    `}
                </div>
            `).join('');
        }
        
        // Close resource selection modal and open config modal
        bootstrap.Modal.getInstance(document.getElementById('resourceSelectionModal')).hide();
        new bootstrap.Modal(document.getElementById('resourceConfigModal')).show();
    })
    .catch(error => {
        console.error('Error loading resource config:', error);
        alert('Error loading resource configuration: ' + error.message);
    });
}

function addResourceToSession() {
    const form = document.getElementById('resourceConfigForm');
    const formData = new FormData(form);
    
    const configuration = {};
    for (const [key, value] of formData.entries()) {
        if (key !== 'resource_type' && key !== 'session_id' && value) {
            configuration[key] = value;
        }
    }
    
    const data = {
        resource_type: formData.get('resource_type'),
        resource_name: configuration.name || 'resource',
        configuration: configuration
    };
    
    fetch(`/template-wizard/sessions/${currentWizardSession}/resources`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Resource added successfully!');
            bootstrap.Modal.getInstance(document.getElementById('resourceConfigModal')).hide();
            // Refresh the current step
            updateWizardStep();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        alert('Error: ' + error);
    });
}

function generateTemplate() {
    fetch(`/template-wizard/sessions/${currentWizardSession}/generate`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Template generated successfully!');
            // Redirect to templates page or show the generated template
            window.location.href = '/templates';
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        alert('Error: ' + error);
    });
}

function deleteWizardSession(sessionId) {
    if (confirm('Are you sure you want to delete this wizard session?')) {
        fetch(`/template-wizard/sessions/${sessionId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Session deleted successfully!');
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            alert('Error: ' + error);
        });
    }
}

// Event listeners
document.getElementById('resourceSelectionModal').addEventListener('show.bs.modal', function() {
    loadResourceGrid();
});
</script>
{% endblock %}
