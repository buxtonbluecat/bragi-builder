{% extends "base.html" %}

{% block title %}Offline Review - Bragi Builder{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-search"></i> Offline Template Review
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#newSessionModal">
                <i class="fas fa-plus"></i> New Review Session
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="location.reload()">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
    </div>
</div>

<!-- Review Sessions -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Review Sessions</h5>
            </div>
            <div class="card-body">
                <div id="sessionsList">
                    <!-- Sessions will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Session Details (hidden by default) -->
<div id="sessionDetails" class="row" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0" id="sessionTitle">Session Details</h5>
                <div class="btn-group">
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="addTemplateToSession()">
                        <i class="fas fa-plus"></i> Add Template
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-success" onclick="analyzeSession()">
                        <i class="fas fa-chart-line"></i> Analyze
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-info" onclick="exportSession()">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="sessionContent">
                    <!-- Session content will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New Session Modal -->
<div class="modal fade" id="newSessionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Review Session</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="newSessionForm">
                    <div class="mb-3">
                        <label for="sessionName" class="form-label">Session Name</label>
                        <input type="text" class="form-control" id="sessionName" name="session_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="environment" class="form-label">Environment</label>
                        <select class="form-select" id="environment" name="environment" required>
                            <option value="dev">Development</option>
                            <option value="sit">SIT</option>
                            <option value="uat">UAT</option>
                            <option value="pre-prod">Pre-Production</option>
                            <option value="prod">Production</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="workloadSize" class="form-label">Workload Size</label>
                        <select class="form-select" id="workloadSize" name="workload_size" required>
                            <option value="small">Small</option>
                            <option value="medium">Medium</option>
                            <option value="large">Large</option>
                            <option value="enterprise">Enterprise</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="dwhEnvironments" class="form-label">Additional DWH Environments</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dwhSit" name="dwh_environments" value="sit">
                            <label class="form-check-label" for="dwhSit">SIT</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dwhUat" name="dwh_environments" value="uat">
                            <label class="form-check-label" for="dwhUat">UAT</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dwhPreProd" name="dwh_environments" value="pre-prod">
                            <label class="form-check-label" for="dwhPreProd">Pre-Production</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="dwhProd" name="dwh_environments" value="prod">
                            <label class="form-check-label" for="dwhProd">Production</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createSession()">Create Session</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Template Modal -->
<div class="modal fade" id="addTemplateModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Template to Session</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addTemplateForm">
                    <input type="hidden" id="currentSessionId" name="session_id">
                    <div class="mb-3">
                        <label for="templateSelect" class="form-label">Template</label>
                        <select class="form-select" id="templateSelect" name="template_name" required>
                            <option value="">Select a template...</option>
                            {% for template in templates %}
                            <option value="{{ template }}">{{ template }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="customParameters" class="form-label">Custom Parameters (JSON)</label>
                        <textarea class="form-control" id="customParameters" name="custom_parameters" rows="6" 
                                  placeholder='{"param1": "value1", "param2": "value2"}'></textarea>
                        <div class="form-text">Leave empty to use workload configuration defaults</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addTemplate()">Add Template</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentSessionId = null;

// Load sessions on page load
document.addEventListener('DOMContentLoaded', function() {
    loadSessions();
});

function loadSessions() {
    fetch('/offline-review/sessions')
    .then(response => response.json())
    .then(data => {
        displaySessions(data.sessions || []);
    })
    .catch(error => {
        console.error('Error loading sessions:', error);
    });
}

function displaySessions(sessions) {
    const container = document.getElementById('sessionsList');
    
    if (sessions.length === 0) {
        container.innerHTML = '<p class="text-muted">No review sessions found. Create one to get started.</p>';
        return;
    }
    
    container.innerHTML = sessions.map(session => `
        <div class="card mb-3">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <h6 class="card-title">${session.session_name}</h6>
                        <p class="card-text">
                            <span class="badge bg-primary">${session.environment}</span>
                            <span class="badge bg-secondary">${session.size}</span>
                            <span class="badge bg-info">${session.template_count} templates</span>
                        </p>
                        <small class="text-muted">Created: ${new Date(session.created_at).toLocaleString()}</small>
                    </div>
                    <div class="col-md-4 text-end">
                        <button class="btn btn-sm btn-outline-primary" onclick="openSession('${session.session_id}')">
                            <i class="fas fa-eye"></i> Open
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteSession('${session.session_id}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

function createSession() {
    const form = document.getElementById('newSessionForm');
    const formData = new FormData(form);
    
    const data = {
        session_name: formData.get('session_name'),
        environment: formData.get('environment'),
        size: formData.get('workload_size'),
        dwh_environments: Array.from(formData.getAll('dwh_environments'))
    };
    
    fetch('/offline-review/sessions', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Session created successfully!');
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        alert('Error: ' + error);
    });
}

function openSession(sessionId) {
    currentSessionId = sessionId;
    
    fetch(`/offline-review/sessions/${sessionId}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displaySessionDetails(data.session);
            document.getElementById('sessionDetails').style.display = 'block';
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        alert('Error: ' + error);
    });
}

function displaySessionDetails(session) {
    document.getElementById('sessionTitle').textContent = session.session_name;
    
    const content = document.getElementById('sessionContent');
    content.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6>Configuration</h6>
                <p><strong>Environment:</strong> ${session.environment}</p>
                <p><strong>Size:</strong> ${session.size}</p>
                <p><strong>Created:</strong> ${new Date(session.created_at).toLocaleString()}</p>
            </div>
            <div class="col-md-6">
                <h6>Workload Configuration</h6>
                <p><strong>App Service SKU:</strong> ${session.workload_config.app_service.sku}</p>
                <p><strong>Storage SKU:</strong> ${session.workload_config.storage.sku}</p>
                <p><strong>SQL Databases:</strong> ${Object.keys(session.workload_config.sql_databases).length}</p>
            </div>
        </div>
        
        <hr>
        
        <h6>Templates in Session</h6>
        <div id="templatesList">
            ${Object.keys(session.templates).map(templateName => `
                <div class="card mb-2">
                    <div class="card-body">
                        <h6 class="card-title">${templateName}</h6>
                        <p class="card-text">
                            <span class="badge bg-success">${session.templates[templateName].preview.resources.length} resources</span>
                            <span class="badge bg-warning">$${session.templates[templateName].preview.estimated_costs.monthly_estimate}/month</span>
                        </p>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewTemplatePreview('${templateName}')">
                            <i class="fas fa-eye"></i> Preview
                        </button>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

function addTemplateToSession() {
    if (!currentSessionId) {
        alert('Please open a session first');
        return;
    }
    
    document.getElementById('currentSessionId').value = currentSessionId;
    new bootstrap.Modal(document.getElementById('addTemplateModal')).show();
}

function addTemplate() {
    const form = document.getElementById('addTemplateForm');
    const formData = new FormData(form);
    
    const data = {
        session_id: formData.get('session_id'),
        template_name: formData.get('template_name'),
        custom_parameters: formData.get('custom_parameters') ? JSON.parse(formData.get('custom_parameters')) : null
    };
    
    fetch(`/offline-review/sessions/${data.session_id}/templates`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Template added successfully!');
            openSession(currentSessionId); // Refresh session view
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        alert('Error: ' + error);
    });
}

function analyzeSession() {
    if (!currentSessionId) {
        alert('Please open a session first');
        return;
    }
    
    fetch(`/offline-review/sessions/${currentSessionId}/analyze`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayAnalysis(data.analysis);
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        alert('Error: ' + error);
    });
}

function displayAnalysis(analysis) {
    const content = document.getElementById('sessionContent');
    content.innerHTML += `
        <hr>
        <h6>Analysis Results</h6>
        <div class="row">
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">${analysis.total_templates}</h5>
                        <p class="card-text">Templates</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">${analysis.total_resources}</h5>
                        <p class="card-text">Resources</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">$${analysis.total_estimated_cost.toFixed(2)}</h5>
                        <p class="card-text">Monthly Cost</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-3">
            <h6>Recommendations</h6>
            <ul class="list-group">
                ${analysis.recommendations.map(rec => `<li class="list-group-item">${rec}</li>`).join('')}
            </ul>
        </div>
    `;
}

function exportSession() {
    if (!currentSessionId) {
        alert('Please open a session first');
        return;
    }
    
    fetch(`/offline-review/sessions/${currentSessionId}/export`)
    .then(response => response.blob())
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `session_${currentSessionId}.zip`;
        a.click();
        window.URL.revokeObjectURL(url);
    })
    .catch(error => {
        alert('Error: ' + error);
    });
}

function deleteSession(sessionId) {
    if (confirm('Are you sure you want to delete this session?')) {
        fetch(`/offline-review/sessions/${sessionId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Session deleted successfully!');
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            alert('Error: ' + error);
        });
    }
}
</script>
{% endblock %}
