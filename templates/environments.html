{% extends "base.html" %}

{% block title %}Environment Management - Bragi Builder{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h2>Environment Management</h2>
            <p class="text-muted">Manage your deployed Azure environments</p>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Deployed Environments</h5>
                </div>
                <div class="card-body">
                    <div id="environments-list">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading environments...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadEnvironments();
});

function loadEnvironments() {
    // Get resource groups that match our naming pattern
    fetch('/resource-groups')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayEnvironments(data.resource_groups);
            } else {
                document.getElementById('environments-list').innerHTML = 
                    '<div class="alert alert-danger">Error loading environments: ' + data.message + '</div>';
            }
        })
        .catch(error => {
            document.getElementById('environments-list').innerHTML = 
                '<div class="alert alert-danger">Error loading environments: ' + error.message + '</div>';
        });
}

function displayEnvironments(resourceGroups) {
    const container = document.getElementById('environments-list');
    
    // Filter resource groups that were created by Bragi Builder
    const environments = resourceGroups.filter(rg => {
        // Check if this resource group has the Bragi Builder tag
        return rg.tags && rg.tags.CreatedBy === 'Bragi Builder';
    });
    
    if (environments.length === 0) {
        container.innerHTML = '<div class="alert alert-info">No environments found.</div>';
        return;
    }
    
    let html = '<div class="row">';
    
    environments.forEach(env => {
        // Get project and environment from tags, fallback to name parsing
        let projectName = env.tags?.Project || 'Unknown Project';
        let environment = env.tags?.Environment || 'Unknown Environment';
        let deploymentType = env.tags?.DeploymentType || 'Unknown';
        
        // If we have a complete environment deployment, try to parse from name
        if (deploymentType === 'Complete Environment' && env.name.includes('-')) {
            const parts = env.name.split('-');
            if (parts.length >= 3 && parts[parts.length - 1] === 'rg') {
                projectName = parts.slice(0, -2).join('-');
                environment = parts[parts.length - 2];
            }
        }
        
        html += `
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card h-100">
                    <div class="card-body">
                        <h6 class="card-title">${projectName} - ${environment}</h6>
                        <p class="card-text">
                            <small class="text-muted">
                                Resource Group: ${env.name}<br>
                                Location: ${env.location}<br>
                                Type: <span class="badge bg-info">${deploymentType}</span><br>
                                Status: <span class="badge bg-success">Active</span>
                                ${env.tags?.CreatedDate ? '<br>Created: ' + env.tags.CreatedDate : ''}
                            </small>
                        </p>
                    </div>
                    <div class="card-footer">
                        <div class="btn-group w-100 mb-2" role="group">
                            <button class="btn btn-outline-primary btn-sm" onclick="viewEndpoints('${environment}', '${projectName}', '${env.name}')">
                                <i class="bi bi-eye"></i> Endpoints
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="deleteEnvironment('${environment}', '${projectName}', '${env.name}')">
                                <i class="bi bi-trash"></i> Delete
                            </button>
                        </div>
                        <div class="btn-group w-100" role="group">
                            <button class="btn btn-outline-success btn-sm" onclick="startResources('${env.name}')" id="start-btn-${env.name}">
                                <i class="bi bi-play-circle"></i> Start
                            </button>
                            <button class="btn btn-outline-warning btn-sm" onclick="stopResources('${env.name}')" id="stop-btn-${env.name}">
                                <i class="bi bi-stop-circle"></i> Stop
                            </button>
                            <button class="btn btn-outline-info btn-sm" onclick="viewResourceStatus('${env.name}')" id="status-btn-${env.name}">
                                <i class="bi bi-info-circle"></i> Status
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

function viewEndpoints(environment, projectName, resourceGroupName) {
    window.open(`/environments/${environment}/endpoints?project_name=${projectName}&resource_group=${resourceGroupName}`, '_blank');
}

function deleteEnvironment(environment, projectName, resourceGroupName) {
    // First, get deletion preview
    showDeletePreviewModal(environment, projectName, resourceGroupName);
}

function showDeletePreviewModal(environment, projectName, resourceGroupName) {
    // Show loading state
    const modal = createDeletePreviewModal();
    document.body.appendChild(modal);
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
    
    // Update modal with loading state
    const modalBody = modal.querySelector('.modal-body');
    modalBody.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div><p class="mt-2">Loading deletion preview...</p></div>';
    
    // Fetch preview data
    fetch(`/environments/${environment}/delete-preview?project_name=${projectName}&resource_group=${encodeURIComponent(resourceGroupName)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayDeletePreview(modal, data, environment, projectName, resourceGroupName);
            } else {
                modalBody.innerHTML = `<div class="alert alert-danger">Error: ${data.message}</div>`;
            }
        })
        .catch(error => {
            modalBody.innerHTML = `<div class="alert alert-danger">Error loading preview: ${error.message}</div>`;
        });
}

function createDeletePreviewModal() {
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'deletePreviewModal';
    modal.setAttribute('tabindex', '-1');
    modal.setAttribute('aria-labelledby', 'deletePreviewModalLabel');
    modal.setAttribute('aria-hidden', 'true');
    modal.innerHTML = `
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="deletePreviewModalLabel">
                        <i class="fas fa-exclamation-triangle"></i> Confirm Environment Deletion
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="deletePreviewBody">
                    <!-- Content will be populated dynamically -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn" disabled>
                        <i class="fas fa-trash"></i> Confirm Deletion
                    </button>
                </div>
            </div>
        </div>
    `;
    return modal;
}

function displayDeletePreview(modal, previewData, environment, projectName, resourceGroupName) {
    const modalBody = document.getElementById('deletePreviewBody');
    const confirmBtn = document.getElementById('confirmDeleteBtn');
    
    let html = `
        <div class="alert alert-warning">
            <strong><i class="fas fa-exclamation-triangle"></i> Warning:</strong> This action cannot be undone!
            All resources in the resource group will be permanently deleted.
        </div>
        
        <h6><i class="fas fa-info-circle"></i> Environment Information</h6>
        <table class="table table-sm table-bordered mb-4">
            <tr><th width="40%">Resource Group</th><td><code>${previewData.resource_group}</code></td></tr>
            <tr><th>Environment</th><td><strong>${previewData.environment}</strong></td></tr>
            <tr><th>Project</th><td>${previewData.project_name}</td></tr>
            <tr><th>Location</th><td>${previewData.location}</td></tr>
            <tr><th>Resource Count</th><td><strong>${previewData.resource_count}</strong> resources</td></tr>
            <tr><th>Estimated Deletion Time</th><td>${previewData.estimated_deletion_time}</td></tr>
        </table>
    `;
    
    // Show errors if any (blocking deletion)
    if (previewData.errors && previewData.errors.length > 0) {
        html += '<div class="alert alert-danger"><h6><i class="fas fa-ban"></i> Deletion Blocked</h6><ul class="mb-0">';
        previewData.errors.forEach(error => {
            html += `<li>${error.message}</li>`;
        });
        html += '</ul></div>';
        confirmBtn.disabled = true;
    } else {
        confirmBtn.disabled = false;
        confirmBtn.onclick = () => {
            const bsModal = bootstrap.Modal.getInstance(modal);
            bsModal.hide();
            proceedWithDeletion(environment, projectName, resourceGroupName);
        };
    }
    
    // Show warnings
    if (previewData.warnings && previewData.warnings.length > 0) {
        html += '<div class="alert alert-warning"><h6><i class="fas fa-exclamation-triangle"></i> Warnings</h6><ul class="mb-0">';
        previewData.warnings.forEach(warning => {
            const severityClass = warning.severity === 'high' ? 'text-danger' : warning.severity === 'medium' ? 'text-warning' : 'text-info';
            html += `<li class="${severityClass}">${warning.message}</li>`;
        });
        html += '</ul></div>';
    }
    
    // Show resource locks
    if (previewData.locks && previewData.locks.length > 0) {
        html += '<h6><i class="fas fa-lock"></i> Resource Locks</h6><ul class="mb-4">';
        previewData.locks.forEach(lock => {
            const lockBadge = lock.level === 'CanNotDelete' ? 'danger' : 'warning';
            html += `<li><span class="badge bg-${lockBadge}">${lock.level}</span> ${lock.name}${lock.notes ? ': ' + lock.notes : ''}</li>`;
        });
        html += '</ul>';
    }
    
    // Show resource types summary
    if (previewData.resource_types && Object.keys(previewData.resource_types).length > 0) {
        html += '<h6><i class="fas fa-list"></i> Resource Types Summary</h6>';
        html += '<div class="row mb-4">';
        for (const [type, count] of Object.entries(previewData.resource_types)) {
            html += `<div class="col-md-6 mb-2"><span class="badge bg-secondary">${type}</span> <strong>${count}</strong></div>`;
        }
        html += '</div>';
    }
    
    // Show resources list (collapsible)
    if (previewData.resources && previewData.resources.length > 0) {
        html += `
            <h6>
                <i class="fas fa-server"></i> Resources to be Deleted (${previewData.resources.length})
                <button class="btn btn-sm btn-outline-secondary ms-2" type="button" data-bs-toggle="collapse" data-bs-target="#resourcesList">
                    <i class="fas fa-chevron-down"></i> Show/Hide
                </button>
            </h6>
            <div class="collapse" id="resourcesList">
                <div class="table-responsive mb-4" style="max-height: 300px; overflow-y: auto;">
                    <table class="table table-sm table-striped">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th>Resource Name</th>
                                <th>Type</th>
                                <th>Location</th>
                            </tr>
                        </thead>
                        <tbody>
        `;
        previewData.resources.forEach(resource => {
            html += `<tr><td><code>${resource.name}</code></td><td><small>${resource.type}</small></td><td>${resource.location}</td></tr>`;
        });
        html += `
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }
    
    modalBody.innerHTML = html;
}

function proceedWithDeletion(environment, projectName, resourceGroupName) {
    // Show loading state
    showDeleteProgress(environment, resourceGroupName);
    
    fetch(`/environments/${environment}?project_name=${projectName}&resource_group=${encodeURIComponent(resourceGroupName)}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (data.status === 'running') {
                showDeleteProgress(environment, resourceGroupName, 'Deletion initiated...');
                // Start polling for progress
                pollDeleteProgress(resourceGroupName, environment);
            } else {
                hideDeleteProgress();
                showSuccessNotification(data.message);
                loadEnvironments(); // Refresh the list
            }
        } else {
            hideDeleteProgress();
            showErrorNotification(data.message);
        }
    })
    .catch(error => {
        hideDeleteProgress();
        showErrorNotification('Error deleting environment: ' + error.message);
    });
}

function showDeleteProgress(environment, resourceGroupName, message = 'Deleting environment...') {
    // Create or update progress indicator
    let progressDiv = document.getElementById('delete-progress');
    if (!progressDiv) {
        progressDiv = document.createElement('div');
        progressDiv.id = 'delete-progress';
        progressDiv.className = 'alert alert-info position-fixed';
        progressDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        document.body.appendChild(progressDiv);
    }
    
    progressDiv.innerHTML = `
        <div class="d-flex align-items-center">
            <div class="spinner-border spinner-border-sm me-2" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div>
                <strong>${message}</strong><br>
                <small>Environment: ${environment}</small>
            </div>
        </div>
    `;
    progressDiv.style.display = 'block';
}

function hideDeleteProgress() {
    const progressDiv = document.getElementById('delete-progress');
    if (progressDiv) {
        progressDiv.style.display = 'none';
    }
}

function pollDeleteProgress(resourceGroupName, environment) {
    const checkProgress = () => {
        fetch(`/api/delete-progress/${resourceGroupName}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.status === 'completed') {
                    hideDeleteProgress();
                    showSuccessNotification(data.message);
                    loadEnvironments(); // Refresh the list
                } else if (data.status === 'failed') {
                    hideDeleteProgress();
                    showErrorNotification(data.message);
                } else if (data.status === 'running') {
                    // Update progress message
                    showDeleteProgress(environment, resourceGroupName, data.message);
                    // Continue polling
                    setTimeout(checkProgress, 2000); // Check every 2 seconds
                }
            } else {
                hideDeleteProgress();
                showErrorNotification(data.message);
            }
        })
        .catch(error => {
            hideDeleteProgress();
            showErrorNotification('Error checking delete progress: ' + error);
        });
    };
    
    // Start polling
    setTimeout(checkProgress, 2000);
}

function showSuccessNotification(message) {
    // Create toast notification
    const toast = document.createElement('div');
    toast.className = 'toast align-items-center text-white bg-success border-0 position-fixed';
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 10000;';
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-check-circle me-2"></i>${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    document.body.appendChild(toast);
    
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    // Remove from DOM after hiding
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}

function showErrorNotification(message) {
    // Create toast notification
    const toast = document.createElement('div');
    toast.className = 'toast align-items-center text-white bg-danger border-0 position-fixed';
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 10000;';
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-exclamation-circle me-2"></i>${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    document.body.appendChild(toast);
    
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    // Remove from DOM after hiding
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}

function startResources(resourceGroup) {
    const startBtn = document.getElementById(`start-btn-${resourceGroup}`);
    const stopBtn = document.getElementById(`stop-btn-${resourceGroup}`);
    
    // Disable buttons and show loading
    startBtn.disabled = true;
    startBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Starting...';
    
    fetch(`/api/resource-groups/${resourceGroup}/start`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccessNotification(data.message);
            // Refresh resource status after a delay
            setTimeout(() => {
                viewResourceStatus(resourceGroup);
            }, 2000);
        } else {
            showErrorNotification(data.message);
        }
    })
    .catch(error => {
        showErrorNotification('Error starting resources: ' + error.message);
    })
    .finally(() => {
        // Re-enable buttons
        startBtn.disabled = false;
        startBtn.innerHTML = '<i class="bi bi-play-circle"></i> Start';
    });
}

function stopResources(resourceGroup) {
    const startBtn = document.getElementById(`start-btn-${resourceGroup}`);
    const stopBtn = document.getElementById(`stop-btn-${resourceGroup}`);
    
    // Disable buttons and show loading
    stopBtn.disabled = true;
    stopBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Stopping...';
    
    fetch(`/api/resource-groups/${resourceGroup}/stop`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccessNotification(data.message);
            // Refresh resource status after a delay
            setTimeout(() => {
                viewResourceStatus(resourceGroup);
            }, 2000);
        } else {
            showErrorNotification(data.message);
        }
    })
    .catch(error => {
        showErrorNotification('Error stopping resources: ' + error.message);
    })
    .finally(() => {
        // Re-enable buttons
        stopBtn.disabled = false;
        stopBtn.innerHTML = '<i class="bi bi-stop-circle"></i> Stop';
    });
}

function viewResourceStatus(resourceGroup) {
    const statusBtn = document.getElementById(`status-btn-${resourceGroup}`);
    
    // Show loading
    statusBtn.disabled = true;
    statusBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Loading...';
    
    fetch(`/api/resource-groups/${resourceGroup}/status`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayResourceStatusModal(resourceGroup, data.resources);
        } else {
            showErrorNotification(data.message);
        }
    })
    .catch(error => {
        showErrorNotification('Error loading resource status: ' + error.message);
    })
    .finally(() => {
        // Re-enable button
        statusBtn.disabled = false;
        statusBtn.innerHTML = '<i class="bi bi-info-circle"></i> Status';
    });
}

function displayResourceStatusModal(resourceGroup, resources) {
    // Create modal HTML
    const modalHtml = `
        <div class="modal fade" id="resourceStatusModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Resource Status - ${resourceGroup}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Resource Name</th>
                                        <th>Type</th>
                                        <th>Status</th>
                                        <th>Location</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${resources.map(resource => `
                                        <tr>
                                            <td>${resource.name}</td>
                                            <td><span class="badge bg-secondary">${resource.type}</span></td>
                                            <td><span class="badge ${getStatusBadgeClass(resource.status)}">${resource.status}</span></td>
                                            <td>${resource.location}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" onclick="viewResourceStatus('${resourceGroup}')">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('resourceStatusModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to DOM
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('resourceStatusModal'));
    modal.show();
}

function getStatusBadgeClass(status) {
    switch(status.toLowerCase()) {
        case 'running':
        case 'started':
            return 'bg-success';
        case 'stopped':
        case 'deallocated':
        case 'stopping':
            return 'bg-warning';
        case 'starting':
            return 'bg-info';
        case 'failed':
        case 'error':
            return 'bg-danger';
        default:
            return 'bg-secondary';
    }
}
</script>
{% endblock %}
