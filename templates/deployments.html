{% extends "base.html" %}

{% block title %}Deployments - Bragi Builder{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Deployments</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="location.reload()">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
            <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#deployModal">
                <i class="fas fa-plus"></i> New Deployment
            </button>
        </div>
    </div>
</div>

<!-- Deployments List -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Active Deployments</h5>
            </div>
            <div class="card-body">
                {% if deployments %}
                    {% for deployment in deployments %}
                    <div class="deployment-item mb-3 p-3 {{ deployment.status.lower() if deployment.status else 'unknown' }}">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1">{{ deployment.template_name }}</h6>
                                        <small class="text-muted">
                                            <strong>Resource Group:</strong> {{ deployment.resource_group }}<br>
                                            <strong>Started:</strong> {{ deployment.start_time }}<br>
                                            <strong>Deployment Name:</strong> {{ deployment.deployment_name }}
                                        </small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="mb-2">
                                    <span class="badge bg-{{ 'success' if deployment.status == 'Succeeded' else 'warning' if deployment.status == 'running' else 'danger' if deployment.status == 'Failed' else 'secondary' }} status-badge">
                                        {{ deployment.status or 'Unknown' }}
                                    </span>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-outline-primary" onclick="getDeploymentStatus('{{ deployment.deployment_name }}')">
                                        <i class="fas fa-sync-alt"></i> Refresh Status
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        {% if deployment.outputs %}
                        <div class="mt-3">
                            <button class="btn btn-sm btn-outline-info" type="button" data-bs-toggle="collapse" data-bs-target="#outputs_{{ loop.index }}">
                                <i class="fas fa-eye"></i> View Outputs
                            </button>
                            <div class="collapse mt-2" id="outputs_{{ loop.index }}">
                                <div class="card card-body">
                                    <pre class="mb-0"><code>{{ deployment.outputs|tojson(indent=2) }}</code></pre>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-rocket fa-3x text-muted mb-3"></i>
                        <h3 class="text-muted">No Deployments</h3>
                        <p class="text-muted">Start your first deployment to see it here.</p>
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#deployModal">
                            <i class="fas fa-plus"></i> Create Deployment
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Deploy Modal -->
<div class="modal fade" id="deployModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Deploy Template</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="deployForm">
                    <div class="mb-3">
                        <label for="templateName" class="form-label">Template</label>
                        <select class="form-select" id="templateName" name="template_name" required>
                            <option value="">Select a template...</option>
                            {% for template in templates %}
                            <option value="{{ template }}">{{ template }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="resourceGroup" class="form-label">Resource Group</label>
                        <select class="form-select" id="resourceGroup" name="resource_group" required>
                            <option value="">Select or create resource group...</option>
                            {% for rg in resource_groups %}
                            <option value="{{ rg.name }}">{{ rg.name }} ({{ rg.location }})</option>
                            {% endfor %}
                        </select>
                        <div class="form-text">Or enter a new resource group name to create it</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="location" class="form-label">Location</label>
                        <select class="form-select" id="location" name="location">
                            <option value="East US">East US</option>
                            <option value="West US">West US</option>
                            <option value="West Europe">West Europe</option>
                            <option value="East Asia">East Asia</option>
                        </select>
                        <div class="form-text">Used when creating a new resource group</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="parameters" class="form-label">Parameters (JSON)</label>
                        <textarea class="form-control" id="parameters" name="parameters" rows="4" placeholder='{"param1": "value1", "param2": "value2"}'></textarea>
                        <div class="form-text">Enter parameters as JSON (optional)</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="deployTemplate()">Deploy Template</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function deployTemplate() {
    const form = document.getElementById('deployForm');
    const formData = new FormData(form);
    
    const data = {
        template_name: formData.get('template_name'),
        resource_group: formData.get('resource_group'),
        location: formData.get('location')
    };
    
    // Parse parameters JSON
    const parametersText = formData.get('parameters');
    if (parametersText.trim()) {
        try {
            data.parameters = JSON.parse(parametersText);
        } catch (e) {
            alert('Invalid JSON in parameters field');
            return;
        }
    }
    
    fetch('/deploy', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Deployment started successfully!');
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        alert('Error: ' + error);
    });
}

function getDeploymentStatus(deploymentName) {
    fetch(`/deployments/${deploymentName}/status`)
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            alert(`Status: ${data.status}\nStarted: ${data.start_time}`);
            location.reload();
        }
    })
    .catch(error => {
        alert('Error: ' + error);
    });
}
</script>
{% endblock %}
